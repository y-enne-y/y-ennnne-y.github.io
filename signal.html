<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최적 출발 시간 알리미</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 1rem;
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }
        .box {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .info-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }
        .info-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
        }
        .info-content .highlight {
            font-weight: bold;
            color: #007bff;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚇 최적 출발 시간 알리미 🚌</h1>

        <div class="box" id="result-box">
            <div class="info-title">최적 경로 정보</div>
            <div class="info-content" id="result-content">🔄 데이터를 불러오는 중입니다...</div>
        </div>

    </div>

    <script>
        // =================================================================
        //                        ⚠️ 설정 값 (사용자 직접 입력)
        // =================================================================

        // 1. 서울 열린데이터광장에서 발급받은 본인의 API 키를 입력하세요.
        // 지하철과 버스 API 키가 동일할 수 있습니다.
        const API_KEY = '여기에 본인의 API 키를 입력하세요';

        // 2. 지하철 역/버스 정류소 ID (아래 'ID 찾는 법' 참고)
        const SUBWAY_STATION_NAME = '신림'; // 2호선 신림역
        const BUS_ARS_ID = '13145';      // 신촌역2호선중앙차로 정류장 ARS ID

        // 3. 평균 소요 시간 (단위: 분) - 본인에게 맞게 조정하세요.
        const TIME_HOME_TO_SUBWAY = 10;      // 집 -> 신림역까지 도보 시간
        const TIME_SUBWAY_RIDE = 22;         // 신림역 -> 신촌역 지하철 소요 시간
        const TIME_SUBWAY_TO_BUS = 5;        // 신촌역 하차 -> 버스 정류장까지 환승 시간

        // =================================================================

        const resultBox = document.getElementById('result-box');
        const resultContent = document.getElementById('result-content');

        // CORS 오류를 우회하기 위한 프록시 서버 URL
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';

        // 지하철 실시간 도착 정보 API URL (역 이름으로 조회)
        const subwayUrl = `http://swopenAPI.seoul.go.kr/api/subway/${API_KEY}/json/realtimeStationArrival/0/10/${encodeURIComponent(SUBWAY_STATION_NAME)}`;

        // 버스 실시간 도착 정보 API URL (정류소 ARS ID로 조회)
        const busUrl = `http://ws.bus.go.kr/api/rest/stationinfo/getStationByUid?serviceKey=${API_KEY}&arsId=${BUS_ARS_ID}&resultType=json`;

        async function fetchDepartureInfo() {
            try {
                // 1. API 병렬 호출 (지하철, 버스 정보 동시에 요청)
                const [subwayRes, busRes] = await Promise.all([
                    fetch(proxyUrl + subwayUrl),
                    fetch(proxyUrl + busUrl)
                ]);

                if (!subwayRes.ok || !busRes.ok) {
                    throw new Error('API 호출에 실패했습니다. 키를 확인해주세요.');
                }

                const subwayJson = await subwayRes.json();
                const busJson = await busRes.json();

                // 2. 데이터 파싱 및 가공
                const nextSubway = parseSubwayData(subwayJson);
                const targetBuses = parseBusData(busJson);

                if (!nextSubway) {
                    throw new Error('현재 운행 중인 신촌 방면 지하철이 없습니다.');
                }
                if (targetBuses.length === 0) {
                    throw new Error('운행 중인 서대문03/04 버스가 없습니다.');
                }

                // 3. 최적 출발 시간 계산
                const result = calculateOptimalDeparture(nextSubway, targetBuses);
                
                // 4. 결과 출력
                displayResult(result);

            } catch (err) {
                console.error("Error:", err);
                resultContent.innerHTML = `<div class="error-message">🚫 ${err.message}</div><p style="font-size:0.9rem; color:#666; margin-top:10px;">CORS 오류일 경우, <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">여기</a>를 방문하여 임시 액세스를 활성화해야 할 수 있습니다.</p>`;
            }
        }

        function parseSubwayData(data) {
            if (!data.realtimeArrivalList) return null;

            // 2호선 내선순환(신촌 방향) 열차만 필터링
            const upcomingTrain = data.realtimeArrivalList.find(train => 
                train.subwayId === '1002' && train.updnLine.includes('내선')
            );
            
            if (!upcomingTrain) return null;

            return {
                arrivalMsg: upcomingTrain.arvlMsg2, // "전역 도착", "3분 후" 등
                remainingTime: parseInt(upcomingTrain.barvlDt) // 도착까지 남은 시간(초)
            };
        }

        function parseBusData(data) {
            if (!data.msgBody || !data.msgBody.itemList) return [];
            
            // 서대문03, 서대문04 버스만 필터링
            return data.msgBody.itemList
                .filter(bus => bus.rtNm === '서대문03' || bus.rtNm === '서대문04')
                .map(bus => ({
                    busName: bus.rtNm,
                    remainingTime: parseInt(bus.traTime1) // 첫 번째 버스 도착까지 남은 시간(초)
                }))
                .sort((a, b) => a.remainingTime - b.remainingTime); // 가장 빨리 오는 순으로 정렬
        }

        function calculateOptimalDeparture(subway, buses) {
            const now = new Date();

            // 현재 탈 수 있는 가장 빠른 지하철이 신림역에 도착할 시간
            const subwayArrivalTime = new Date(now.getTime() + subway.remainingTime * 1000);
