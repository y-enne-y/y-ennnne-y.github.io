<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì‹ í˜¸ë“± ì •ë³´</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 1rem;
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }
        .box {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        .signal-status {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }
        .signal-remaining {
            font-size: 1.2rem;
            color: #555;
        }
        .map-container iframe {
            width: 100%;
            height: 250px;
            border: 0;
            border-radius: 12px;
        }
        .home-button a {
            display: inline-block;
            margin-top: 1rem;
            padding: 12px 24px;
            font-size: 1rem;
            background-color: #e9ecef;
            color: #495057;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .home-button a:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ì‹¤ì‹œê°„ ì‹ í˜¸ë“± ì •ë³´</h1>

        <div class="box" id="signal-box">
            <div class="signal-status" id="signal-status">ì •ë³´ í™•ì¸ ì¤‘...</div>
            <div class="signal-remaining" id="signal-remaining"></div>
        </div>

        <div class="box map-container">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3165.655843810811!2d126.92660131557163!3d37.4849369798132!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x357c9df5b8719813%3A0x6b31522a440c95a3!2z7Iug66a87Jet!5e0!3m2!1sko!2skr!4v1661581234567!5m2!1sko!2skr"
              allowfullscreen
              loading="lazy">
            </iframe>
        </div>

        <div class="home-button">
            <a href="index.html">ğŸ  í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

    <script>
        // ì¤‘ìš”: ì´ APIí‚¤ëŠ” ì„œìš¸ì‹œì—ì„œ ë°œê¸‰ë°›ì€ ë³¸ì¸ì˜ í‚¤ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        const apiKey = 'ë³¸ì¸ì˜ API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”'; 
        
        // ì¤‘ìš”: ì„œìš¸ ì—´ë¦°ë°ì´í„°ê´‘ì¥ì—ì„œ ì œê³µí•˜ëŠ” V2X ì§€ì› êµì°¨ë¡œ ID ëª©ë¡ì„ í™•ì¸í•˜ê³ 
        // ë³¸ì¸ê³¼ ê°€ì¥ ê°€ê¹Œìš´ êµì°¨ë¡œ IDë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        const intersectionId = '1042'; 

        const url = `https://t-data.seoul.go.kr/apig/apiman-gateway/tapi/v2xSignalPhaseTimingInformation/1.0?apikey=${apiKey}&intersectionId=${intersectionId}`;

        const statusEl = document.getElementById('signal-status');
        const remainingEl = document.getElementById('signal-remaining');
        const boxEl = document.getElementById('signal-box');

        let signalSchedule = []; // ì‹ í˜¸ ì‹œê°„í‘œë¥¼ ì €ì¥í•  ë°°ì—´
        let countdownInterval;   // ìì²´ ì¹´ìš´íŠ¸ë‹¤ìš´ì„ ìœ„í•œ ë³€ìˆ˜

        // APIë¡œë¶€í„° ì‹ í˜¸ 'ì‹œê°„í‘œ'ë¥¼ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜ (ìµœì´ˆ 1íšŒ ë° ì£¼ê¸°ì  í˜¸ì¶œ)
        async function fetchSignalSchedule() {
            statusEl.textContent = 'ğŸ”„ ì‹ í˜¸ ì‹œê°„í‘œ ìˆ˜ì‹  ì¤‘...';
            try {
                // CORS ë¬¸ì œë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•œ í”„ë¡ì‹œ URL (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì§ì ‘ êµ¬ì¶• í•„ìš”)
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const res = await fetch(proxyUrl + url);

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const json = await res.json();
                signalSchedule = json.data; // ë°›ì•„ì˜¨ ì‹œê°„í‘œë¥¼ ì €ì¥

                // ì‹œê°„í‘œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë°›ì•„ì˜¤ë©´, ìì²´ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                startLocalCountdown();

            } catch (err) {
                console.error("API Fetch Error:", err);
                statusEl.textContent = 'ğŸš« ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨';
                remainingEl.textContent = 'CORS ì •ì±… ë˜ëŠ” API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            }
        }

        // ë°›ì•„ì˜¨ ì‹œê°„í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ 1ì´ˆë§ˆë‹¤ í™”ë©´ì„ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
        function updateDisplay() {
            const now = new Date();
            
            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì‹ í˜¸ ì°¾ê¸°
            const currentPhase = signalSchedule.find(phase => {
                const startTime = parseApiTime(phase.startTime);
                const endTime = parseApiTime(phase.endTime);
                return startTime <= now && endTime > now;
            });

            if (currentPhase) {
                const endTime = parseApiTime(currentPhase.endTime);
                const remainingSeconds = Math.round((endTime - now) / 1000);

                statusEl.textContent = getPhaseDescription(currentPhase.signalPhase);
                remainingEl.textContent = `${remainingSeconds}ì´ˆ í›„ ë³€ê²½`;

                setBoxColor(currentPhase.signalPhase);
            } else {
                statusEl.textContent = 'í˜„ì¬ ì‹ í˜¸ ì •ë³´ ì—†ìŒ';
                remainingEl.textContent = 'ì‹œê°„í‘œë¥¼ ë‹¤ì‹œ í™•ì¸í•©ë‹ˆë‹¤.';
                boxEl.style.backgroundColor = 'white';
            }
        }
        
        // ìì²´ ì¹´ìš´íŠ¸ë‹¤ìš´ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
        function startLocalCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval); // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆë‹¤ë©´ ì¤‘ì§€
            }
            // 1ì´ˆë§ˆë‹¤ í™”ë©´ ì—…ë°ì´íŠ¸ ì‹¤í–‰
            countdownInterval = setInterval(updateDisplay, 1000);
            updateDisplay(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
        }

        // APIê°€ ì œê³µí•˜ëŠ” ì‹œê°„ ë¬¸ìì—´(YYYYMMDDHHMMSS)ì„ Date ê°ì²´ë¡œ ë³€í™˜
        function parseApiTime(timeStr) {
            const y = timeStr.substring(0, 4);
            const m = timeStr.substring(4, 6) - 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘
            const d = timeStr.substring(6, 8);
            const h = timeStr.substring(8, 10);
            const min = timeStr.substring(10, 12);
            const s = timeStr.substring(12, 14);
            return new Date(y, m, d, h, min, s);
        }
        
        // ì‹ í˜¸ ìƒíƒœì— ë”°ë¼ ë¬¸êµ¬ ë³€í™˜
        function getPhaseDescription(phase) {
            switch(phase) {
                case 'GREEN': return 'ğŸŸ¢ ì§ì§„ ê°€ëŠ¥';
                case 'RED': return 'ğŸ”´ ì •ì§€ ì‹ í˜¸';
                case 'YELLOW': return 'ğŸŸ¡ ì£¼ì˜ ì‹ í˜¸';
                case 'LEFT_TURN': return 'â¬…ï¸ ì¢ŒíšŒì „ ê°€ëŠ¥';
                default: return phase;
            }
        }

        // ì‹ í˜¸ ìƒíƒœì— ë”°ë¼ ë°°ê²½ìƒ‰ ë³€ê²½
        function setBoxColor(phase) {
            if (phase.includes('GREEN') || phase.includes('LEFT_TURN')) {
                boxEl.style.backgroundColor = '#d4edda'; // Green
                statusEl.style.color = '#155724';
            } else if (phase.includes('RED')) {
                boxEl.style.backgroundColor = '#f8d7da'; // Red
                statusEl.style.color = '#721c24';
            } else if (phase.includes('YELLOW')) {
                boxEl.style.backgroundColor = '#fff3cd'; // Yellow
                statusEl.style.color = '#856404';
            } else {
                boxEl.style.backgroundColor = 'white';
                statusEl.style.color = '#333';
            }
        }

        // ìµœì´ˆ ì‹¤í–‰
        fetchSignalSchedule();
        // 5ë¶„ì— í•œ ë²ˆì”© ìƒˆë¡œìš´ ì‹œê°„í‘œë¥¼ ë°›ì•„ì™€ì„œ ì—…ë°ì´íŠ¸
        setInterval(fetchSignalSchedule, 300000); 

    </script>
</body>
</html>
